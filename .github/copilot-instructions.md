# Project Guidelines

## Code Style
- Shell scripts are POSIX sh or bash with `set -e`; examples in [src/opencode/install.sh](../src/opencode/install.sh) and [src/persistent-home/install.sh](../src/persistent-home/install.sh).
- Install scripts should be idempotent and use clear logging like the existing patterns in [src/all/install.sh](../src/all/install.sh).

## Architecture
- Each Feature lives in `src/<feature>` and is composed of `devcontainer-feature.json` plus `install.sh`; this is the primary unit of change. See [README.md](../README.md).
- Feature options are declared in `devcontainer-feature.json` and exposed to scripts as sanitized, uppercase env vars per [README.md](../README.md).
- Feature README files are auto-generated from metadata; add human notes in `src/<feature>/NOTES.md` when needed.

## Build and Test
- Install devcontainer CLI (done in devcontainer config): `npm install -g @devcontainers/cli` from [.devcontainer/devcontainer.json](../.devcontainer/devcontainer.json).
- Run per-feature autogenerated tests:
  - `devcontainer features test --features all --remote-user root --skip-scenarios --base-image mcr.microsoft.com/devcontainers/base:ubuntu /path/to/this/repo` from [test/all/test.sh](../test/all/test.sh).
  - `devcontainer features test --features opencode --remote-user root --skip-scenarios --base-image mcr.microsoft.com/devcontainers/base:ubuntu /path/to/this/repo` from [test/opencode/test.sh](../test/opencode/test.sh).
  - `devcontainer features test --features persistent-home --remote-user root --skip-scenarios --base-image mcr.microsoft.com/devcontainers/base:ubuntu /path/to/this/repo` from [test/persistent-home/scenarios.json](../test/persistent-home/scenarios.json).
  - Run scenario tests for a feature (example): `devcontainer features test --features persistent-home --skip-autogenerated /path/to/this/repo` from [test/persistent-home/init_home_from_container.sh](../test/persistent-home/init_home_from_container.sh).

## Project Conventions
- Install scripts run as root and can reference devcontainer-provided user vars (`_REMOTE_USER`, `_CONTAINER_USER`) as shown in [src/persistent-home/install.sh](../src/persistent-home/install.sh).

## Integration Points
- Devcontainer tooling composes feature metadata and runs `install.sh` at build time; this is the primary integration surface (see [README.md](../README.md)).
- Features are published to GHCR via the repository workflow and referenced as `ghcr.io/<owner>/<repo>/<feature>:<version>` in user `devcontainer.json` (see [README.md](../README.md)).

## Security
- Private GHCR feature usage in Codespaces requires `packages: read` and `contents: read` permissions in `devcontainer.json` (see [README.md](../README.md)).
